import {
	getConversationState,
	setConversationState,
	clearConversationState,
	initializeConversationState,
} from "./conversation-state";
import * as Views from "../views/telegram-views";
import { MessageBuilder } from "./message-builder";
import { showPricesUseCase } from "../app/show-prices.use-case";
import { TelegramClient } from "@tg/telegram-client";

const BOT_TOKEN = process.env.BOT_TOKEN || "YOUR_BOT_TOKEN_HERE";
const MASTER_CHAT_ID = process.env.MASTER_CHAT_ID;

export const runBot = async () => {
	if (!BOT_TOKEN || BOT_TOKEN === "YOUR_BOT_TOKEN_HERE") {
		console.error(
			"–û—à–∏–±–∫–∞: –ù–µ –∑–∞–¥–∞–Ω —Ç–æ–∫–µ–Ω –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–∞. –£–∫–∞–∂–∏—Ç–µ –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN.",
		);
		return;
	}
	if (!MASTER_CHAT_ID) {
		console.warn(
			"–í–Ω–∏–º–∞–Ω–∏–µ: –ù–µ –∑–∞–¥–∞–Ω MASTER_CHAT_ID. –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –º–∞—Å—Ç–µ—Ä—É.",
		);
	}

	const client = new TelegramClient(BOT_TOKEN);
	let offset = 0;
	console.log("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...");

	while (true) {
		try {
			const updates = await client.getUpdates({ offset, timeout: 30 });

			for (const update of updates) {
				offset = update.update_id + 1;

				const message = update.message || update.callback_query?.message;
				const chatId = message?.chat.id;
				if (!chatId) continue;

				const currentState =
					getConversationState(chatId) || initializeConversationState(chatId);

				if (update.message?.text) {
					const text = update.message.text;
					console.log(`[${chatId}] Received text: "${text}"`);

					if (text === "/start") {
						clearConversationState(chatId);
						await Views.showMainMenu(client, chatId);
					}
				} else if (
					update.message?.contact &&
					currentState.step === "ASK_PHONE"
				) {
					const phone = update.message.contact.phone_number;
					const name =
						`${update.message.from.first_name} ${update.message.from.last_name || ""}`.trim();

					const summary = new MessageBuilder()
							.addSuccess("–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!")
							.newLine(2)
							.addText(
								"–°–ø–∞—Å–∏–±–æ! –ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–∞—à—É –∑–∞—è–≤–∫—É –∏ —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
							)
							.newLine(2)
							.addSectionTitle("–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏")
							.newLine()
							.addServicesList((currentState.selectedItems || []).map(item => item.name))
							.addBookingDateTime(currentState.selectedDate || "", currentState.selectedTime || "")
							.addContactInfo(name, phone)
							.build();

					await client.sendMessage({
						chat_id: chatId,
						text: summary,
						parse_mode: "MarkdownV2",
						reply_markup: { remove_keyboard: true },
					});
					clearConversationState(chatId);
				} else if (update.callback_query) {
					const callbackData = update.callback_query.data;
					const from = update.callback_query.from;
					console.log(`[${chatId}] Received callback_data: "${callbackData}"`);

					if (callbackData === "emergency_help") {
						clearConversationState(chatId);
						const messageIdToEdit = update.callback_query.message?.message_id;
						await Views.showSelectionScreen(
							client,
							chatId,
							"emergency",
							messageIdToEdit,
						);
					} else if (callbackData === "show_prices") {
						const priceList = await showPricesUseCase();
						const builder = new MessageBuilder()
							.addTitle("üõ† –ù–∞—à–∏ —É—Å–ª—É–≥–∏")
							.newLine(2);
						priceList.forEach((item) => {
							builder
								.addRawText(
									`*${MessageBuilder.escapeMarkdownV2(item.name)}* \- ${MessageBuilder.escapeMarkdownV2(String(item.price))} —Ä—É–±`,
								)
								.newLine()
								.addText(item.description)
								.newLine(2);
						});
						await client.sendMessage({
							chat_id: chatId,
							text: builder.build(),
							parse_mode: "MarkdownV2",
						});
					} else {
						const messageId = currentState.messageId;
						if (!messageId) {
							await client.answerCallbackQuery({
								callback_query_id: update.callback_query.id,
								text: "–û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ —Å /start",
								show_alert: true,
							});
							continue;
						}

						if (callbackData.startsWith("select_item_")) {
							const itemId = callbackData.replace("select_item_", "");
							const flowType = currentState.flowType;
							if (currentState.step === "SELECT_ITEMS" && flowType) {
								const allItems =
									flowType === "emergency"
										? Views.getEmergencyProblems()
										: await Views.getServices();
								const selectedItem = allItems.find((i) => i.id === itemId);
								if (selectedItem) {
									const currentItems = currentState.selectedItems || [];
									const itemIndex = currentItems.findIndex(
										(i) => i.id === itemId,
									);
									const newItems =
										itemIndex > -1
											? currentItems.filter((i) => i.id !== itemId)
											: [...currentItems, selectedItem];
									setConversationState(chatId, {
										...currentState,
										selectedItems: newItems,
									});
									await Views.showSelectionScreen(
										client,
										chatId,
										flowType,
										messageId,
									);
								}
							}
						} else if (callbackData === "selection_next") {
						if (
							currentState.step === "SELECT_ITEMS" &&
							currentState.selectedItems &&
							currentState.selectedItems.length > 0
						) {
							// For emergency flow, skip the confirmation step and go directly to date selection
							if (currentState.flowType === "emergency") {
								await Views.showDateSelectionScreen(client, chatId, messageId);
							} else {
								await Views.showReviewScreen(client, chatId, messageId);
							}
						} else {
							await client.answerCallbackQuery({
								callback_query_id: update.callback_query.id,
								text: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—É–Ω–∫—Ç.",
								show_alert: true,
							});
						}
					} else if (callbackData === "selection_edit") {
							if (
								currentState.step === "REVIEW_SELECTION" &&
								currentState.flowType
							) {
								await Views.showSelectionScreen(
									client,
									chatId,
									currentState.flowType,
									messageId,
								);
							}
						} else if (callbackData === "confirm_selection") {
							if (currentState.step === "REVIEW_SELECTION") {
								await Views.showDateSelectionScreen(client, chatId, messageId);
							}
						} else if (callbackData === "book_now") {
							if (currentState.step === "ASK_DATE" && MASTER_CHAT_ID) {
								const masterMessage = new MessageBuilder()
									.addWarning("–ù–û–í–ê–Ø –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –ó–ê–Ø–í–ö–ê (–°–ï–ô–ß–ê–°)")
									.newLine(2)
									.addDetail(
										"–û—Ç", 
										`${MessageBuilder.escapeMarkdownV2(from.first_name)}${from.last_name ? ` ${MessageBuilder.escapeMarkdownV2(from.last_name)}` : ""} (@${from.username}, ID: ${from.id})`
									)
									.newLine(2)
									.addSectionTitle("–ü—Ä–æ–±–ª–µ–º—ã", "üõ†")
									.newLine();

								(currentState.selectedItems || []).forEach((p) => {
									masterMessage.addListItem(p.name);
								});

								const masterKeyboard: InlineKeyboardMarkup = {
									inline_keyboard: [
										[
											{
												text: "üí¨ –°–≤—è–∑–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º",
												url: `tg://user?id=${from.id}`,
											},
										],
									],
								};

								await client.sendMessage({
									chat_id: MASTER_CHAT_ID,
									text: masterMessage.build(),
									parse_mode: "MarkdownV2",
									reply_markup: masterKeyboard,
								});

								await client.editMessageText({
									chat_id: chatId,
									message_id: messageId,
									text: "‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. –ú–∞—Å—Ç–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.",
									parse_mode: "MarkdownV2",
								});
								clearConversationState(chatId);
							} else if (!MASTER_CHAT_ID) {
								await client.answerCallbackQuery({
									callback_query_id: update.callback_query.id,
									text: "–û—à–∏–±–∫–∞: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –º–∞—Å—Ç–µ—Ä—É.",
									show_alert: true,
								});
							}
						} else if (callbackData.startsWith("book_date_")) {
							const date = callbackData.replace("book_date_", "");
							setConversationState(chatId, {
								...currentState,
								selectedDate: date,
							});
							await Views.showTimeSelectionScreen(client, chatId, messageId);
						} else if (callbackData.startsWith("book_time_")) {
							const time = callbackData.replace("book_time_", "");
							setConversationState(chatId, {
								...currentState,
								step: "ASK_PHONE",
								selectedTime: time,
							});
							await client.editMessageText({
								chat_id: chatId,
								message_id: messageId,
								text: "–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞.",
							});
							await client.sendMessage({
								chat_id: chatId,
								text: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º üëá",
								reply_markup: {
									keyboard: [
										[
											{
												text: "üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º",
												request_contact: true,
											},
										],
									],
									resize_keyboard: true,
									one_time_keyboard: true,
								},
							});
						} else if (callbackData === "cancel_flow") {
							await client.editMessageText({
								chat_id: chatId,
								message_id: messageId,
								text: "‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.",
								parse_mode: "MarkdownV2",
							});
							clearConversationState(chatId);
						}
					}
					await client.answerCallbackQuery({
						callback_query_id: update.callback_query.id,
					});
				}
			}
		} catch (error) {
			console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –≥–ª–∞–≤–Ω–æ–º —Ü–∏–∫–ª–µ –±–æ—Ç–∞:", error);
			await new Promise((resolve) => setTimeout(resolve, 5000));
		}
	}
};
